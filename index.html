<!doctype html>
<head><meta charset="utf-8">
<script src="ecmarkup.js"></script>
<link rel="stylesheet" href="ecmarkup.css">
<title>Module attributes</title>
<script type="application/json" id="menu-search-biblio">[{"type":"clause","id":"intro","aoid":null,"title":"Module attributes","titleHTML":"Module attributes","number":"","namespace":"https://github.com/tc39/proposal-module-attributes","location":"","referencingIds":[],"key":"Module attributes"},{"type":"production","id":"prod-ImportDeclaration","name":"ImportDeclaration","referencingIds":[],"namespace":"https://github.com/tc39/proposal-module-attributes","location":"","key":"ImportDeclaration"},{"type":"production","id":"prod-AsClause","name":"AsClause","referencingIds":["_ref_18","_ref_19","_ref_20"],"namespace":"https://github.com/tc39/proposal-module-attributes","location":"","key":"AsClause"},{"type":"production","id":"prod-ImportCall","name":"ImportCall","referencingIds":["_ref_21"],"namespace":"https://github.com/tc39/proposal-module-attributes","location":"","key":"ImportCall"},{"type":"clause","id":"sec-syntax","aoid":null,"title":"Syntax","titleHTML":"Syntax","number":"1","namespace":"https://github.com/tc39/proposal-module-attributes","location":"","referencingIds":[],"key":"Syntax"},{"type":"clause","id":"sec-import-call-runtime-semantics-evaluation","aoid":null,"title":"Runtime Semantics: Evaluation","titleHTML":"Runtime Semantics: Evaluation","number":"2.1.1","namespace":"https://github.com/tc39/proposal-module-attributes","location":"","referencingIds":[],"key":"Runtime Semantics: Evaluation"},{"type":"clause","id":"sec-import-calls","aoid":null,"title":"Import Calls","titleHTML":"Import Calls","number":"2.1","namespace":"https://github.com/tc39/proposal-module-attributes","location":"","referencingIds":[],"key":"Import Calls"},{"type":"clause","id":"sec-semantics","aoid":null,"title":"Semantics","titleHTML":"Semantics","number":"2","namespace":"https://github.com/tc39/proposal-module-attributes","location":"","referencingIds":[],"key":"Semantics"},{"type":"clause","id":"sec-host-integration","aoid":null,"title":"Sample host integration: The Web embedding","titleHTML":"Sample host integration: The Web embedding","number":"A","namespace":"https://github.com/tc39/proposal-module-attributes","location":"","referencingIds":[],"key":"Sample host integration: The Web embedding"}]</script></head><body><div id="menu-toggle">☰</div><div id="menu-spacer"></div><div id="menu"><div id="menu-search"><input type="text" id="menu-search-box" placeholder="Search..."><div id="menu-search-results" class="inactive"></div></div><div id="menu-pins"><div class="menu-pane-header">Pins</div><ul id="menu-pins-list"></ul></div><div class="menu-pane-header">Table of Contents</div><div id="menu-toc"><ol class="toc"><li><span class="item-toggle-none"></span><a href="#intro" title="Module attributes">Module attributes</a></li><li><span class="item-toggle-none"></span><a href="#sec-syntax" title="Syntax"><span class="secnum">1</span> Syntax</a></li><li><span class="item-toggle">◢</span><a href="#sec-semantics" title="Semantics"><span class="secnum">2</span> Semantics</a><ol class="toc"><li><span class="item-toggle">◢</span><a href="#sec-import-calls" title="Import Calls"><span class="secnum">2.1</span> Import Calls</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-import-call-runtime-semantics-evaluation" title="Runtime Semantics: Evaluation"><span class="secnum">2.1.1</span> RS: Evaluation</a></li></ol></li></ol></li><li><span class="item-toggle-none"></span><a href="#sec-host-integration" title="Sample host integration: The Web embedding"><span class="secnum">A</span> Sample host integration: The Web embedding</a></li></ol></div></div><div id="spec-container"><h1 class="version first">Stage 1 Draft / February 3, 2020</h1>
<emu-intro id="intro">
  <h1>Module attributes</h1>
  <p>See  <a href="https://github.com/tc39/proposal-module-attributes/blob/master/README.md">the explainer</a> for information.</p>
</emu-intro>

<emu-clause id="sec-syntax">
  <h1><span class="secnum">1</span> Syntax</h1>

  <emu-grammar><emu-production name="ImportDeclaration" id="prod-ImportDeclaration">
    <emu-nt><a href="#prod-ImportDeclaration">ImportDeclaration</a></emu-nt><emu-geq>:</emu-geq><emu-rhs a="1a51d4c5"><emu-t>import</emu-t><emu-nt><a href="https://tc39.github.io/ecma262/#prod-ImportClause">ImportClause</a></emu-nt><emu-nt><a href="https://tc39.github.io/ecma262/#prod-FromClause">FromClause</a></emu-nt><emu-t>;</emu-t></emu-rhs>
    <emu-rhs a="a1d094cc"><emu-t>import</emu-t><emu-nt><a href="https://tc39.github.io/ecma262/#prod-ModuleSpecifier">ModuleSpecifier</a></emu-nt><emu-t>;</emu-t></emu-rhs>
    <ins><emu-rhs a="14add0c9"><emu-t>import</emu-t><emu-nt><a href="https://tc39.github.io/ecma262/#prod-ImportClause">ImportClause</a></emu-nt><emu-nt><a href="https://tc39.github.io/ecma262/#prod-FromClause">FromClause</a></emu-nt><emu-nt id="_ref_18"><a href="#prod-AsClause">AsClause</a></emu-nt><emu-t>;</emu-t></emu-rhs></ins>
    <ins><emu-rhs a="6674661b"><emu-t>import</emu-t><emu-nt><a href="https://tc39.github.io/ecma262/#prod-ModuleSpecifier">ModuleSpecifier</a></emu-nt><emu-nt id="_ref_19"><a href="#prod-AsClause">AsClause</a></emu-nt><emu-t>;</emu-t></emu-rhs></ins>
</emu-production>
<emu-production name="AsClause" id="prod-AsClause">
    <emu-nt><a href="#prod-AsClause">AsClause</a></emu-nt><emu-geq>:</emu-geq><ins><emu-rhs a="1915a509"><emu-gann>[no <emu-nt><a href="https://tc39.github.io/ecma262/#prod-LineTerminator">LineTerminator</a></emu-nt> here]</emu-gann><emu-t>as</emu-t><emu-nt><a href="https://tc39.github.io/ecma262/#prod-StringLiteral">StringLiteral</a></emu-nt></emu-rhs>
    </ins>
</emu-production>
<emu-production name="ImportCall" params="Yield, Await" id="prod-ImportCall">
    <emu-nt params="Yield, Await"><a href="#prod-ImportCall">ImportCall</a><emu-mods><emu-params>[Yield, Await]</emu-params></emu-mods></emu-nt><emu-geq>:</emu-geq><emu-rhs a="9710d64c"><emu-t>import</emu-t><emu-t>(</emu-t><emu-nt params="+In, ?Yield, ?Await"><a href="https://tc39.github.io/ecma262/#prod-AssignmentExpression">AssignmentExpression</a><emu-mods><emu-params>[+In, ?Yield, ?Await]</emu-params></emu-mods></emu-nt><emu-t optional="">,<emu-mods><emu-opt>opt</emu-opt></emu-mods></emu-t><emu-t>)</emu-t></emu-rhs>
    <ins><emu-rhs a="571c9520"><emu-t>import</emu-t><emu-t>(</emu-t><emu-nt params="+In, ?Yield, ?Await"><a href="https://tc39.github.io/ecma262/#prod-AssignmentExpression">AssignmentExpression</a><emu-mods><emu-params>[+In, ?Yield, ?Await]</emu-params></emu-mods></emu-nt><emu-t>,</emu-t><emu-nt params="+In, ?Yield, ?Await"><a href="https://tc39.github.io/ecma262/#prod-AssignmentExpression">AssignmentExpression</a><emu-mods><emu-params>[+In, ?Yield, ?Await]</emu-params></emu-mods></emu-nt><emu-t optional="">,<emu-mods><emu-opt>opt</emu-opt></emu-mods></emu-t><emu-t>)</emu-t></emu-rhs></ins>
</emu-production></emu-grammar>
</emu-clause>

<emu-clause id="sec-semantics">
  <h1><span class="secnum">2</span> Semantics</h1>

  <emu-note type="editor"><span class="note">Editor's Note</span><div class="note-contents"><p>Many productions operating on grammar are the same whether or not an <emu-nt id="_ref_20"><a href="#prod-AsClause">AsClause</a></emu-nt>/second <emu-nt id="_ref_21"><a href="#prod-ImportCall">ImportCall</a></emu-nt> parameter is included; the new parameter is ignored. In this section, only the semantically significant changes are included, and the PR to merge into the main specification would fill in the straightforward details.</p></div></emu-note>

    <emu-clause id="sec-import-calls">
      <h1><span class="secnum">2.1</span> Import Calls</h1>

      <emu-clause id="sec-import-call-runtime-semantics-evaluation">
        <h1><span class="secnum">2.1.1</span> Runtime Semantics: Evaluation</h1>

        <emu-grammar><emu-production name="ImportCall" collapsed="">
    <emu-nt><a href="#prod-ImportCall">ImportCall</a></emu-nt><emu-geq>:</emu-geq><emu-rhs a="44ab2e9a"><emu-t>import</emu-t><emu-t>(</emu-t><emu-nt><a href="https://tc39.github.io/ecma262/#prod-AssignmentExpression">AssignmentExpression</a></emu-nt><emu-t optional="">,<emu-mods><emu-opt>opt</emu-opt></emu-mods></emu-t><emu-t>)</emu-t></emu-rhs>
</emu-production></emu-grammar>
        <emu-alg><ol><li>Let <var>referencingScriptOrModule</var> be !&nbsp;<emu-xref aoid="GetActiveScriptOrModule" id="_ref_0"><a href="https://tc39.github.io/ecma262/#sec-getactivescriptormodule">GetActiveScriptOrModule</a></emu-xref>().</li><li>Let <var>argRef</var> be the result of evaluating <emu-nt><a href="https://tc39.github.io/ecma262/#prod-AssignmentExpression">AssignmentExpression</a></emu-nt>.</li><li>Let <var>specifier</var> be ?&nbsp;<emu-xref aoid="GetValue" id="_ref_1"><a href="https://tc39.github.io/ecma262/#sec-getvalue">GetValue</a></emu-xref>(<var>argRef</var>).</li><li>Let <var>promiseCapability</var> be !&nbsp;<emu-xref aoid="NewPromiseCapability" id="_ref_2"><a href="https://tc39.github.io/ecma262/#sec-newpromisecapability">NewPromiseCapability</a></emu-xref>(<emu-xref href="#sec-promise-constructor"><a href="https://tc39.github.io/ecma262/#sec-promise-constructor">%Promise%</a></emu-xref>).</li><li>Let <var>specifierString</var> be <emu-xref aoid="ToString" id="_ref_3"><a href="https://tc39.github.io/ecma262/#sec-tostring">ToString</a></emu-xref>(<var>specifier</var>).</li><li><emu-xref aoid="IfAbruptRejectPromise" id="_ref_4"><a href="https://tc39.github.io/ecma262/#sec-ifabruptrejectpromise">IfAbruptRejectPromise</a></emu-xref>(<var>specifierString</var>, <var>promiseCapability</var>).</li><li>Perform !&nbsp;HostImportModuleDynamically(<var>referencingScriptOrModule</var>, <var>specifierString</var>, <ins><emu-val>undefined</emu-val>,</ins> <var>promiseCapability</var>).</li><li>Return <var>promiseCapability</var>.[[Promise]].
        </li></ol></emu-alg>

        <ins><emu-grammar><emu-production name="ImportCall" collapsed="">
    <emu-nt><a href="#prod-ImportCall">ImportCall</a></emu-nt><emu-geq>:</emu-geq><emu-rhs a="abe89a63"><emu-t>import</emu-t><emu-t>(</emu-t><emu-nt><a href="https://tc39.github.io/ecma262/#prod-AssignmentExpression">AssignmentExpression</a></emu-nt></emu-rhs>
</emu-production></emu-grammar></ins>
        <emu-alg><ol><li>Let <var>referencingScriptOrModule</var> be !&nbsp;<emu-xref aoid="GetActiveScriptOrModule" id="_ref_5"><a href="https://tc39.github.io/ecma262/#sec-getactivescriptormodule">GetActiveScriptOrModule</a></emu-xref>().</li><li>Let <var>argRef</var> be the result of evaluating <ins>the first</ins> <emu-nt><a href="https://tc39.github.io/ecma262/#prod-AssignmentExpression">AssignmentExpression</a></emu-nt>.</li><li>Let <var>specifier</var> be ?&nbsp;<emu-xref aoid="GetValue" id="_ref_6"><a href="https://tc39.github.io/ecma262/#sec-getvalue">GetValue</a></emu-xref>(<var>argRef</var>).</li><li>Let <var>promiseCapability</var> be !&nbsp;<emu-xref aoid="NewPromiseCapability" id="_ref_7"><a href="https://tc39.github.io/ecma262/#sec-newpromisecapability">NewPromiseCapability</a></emu-xref>(<emu-xref href="#sec-promise-constructor"><a href="https://tc39.github.io/ecma262/#sec-promise-constructor">%Promise%</a></emu-xref>).</li><li>Let <var>specifierString</var> be <emu-xref aoid="ToString" id="_ref_8"><a href="https://tc39.github.io/ecma262/#sec-tostring">ToString</a></emu-xref>(<var>specifier</var>).</li><li><emu-xref aoid="IfAbruptRejectPromise" id="_ref_9"><a href="https://tc39.github.io/ecma262/#sec-ifabruptrejectpromise">IfAbruptRejectPromise</a></emu-xref>(<var>specifierString</var>, <var>promiseCapability</var>).</li><li><ins>Let <var>attrRef</var> be the result of evaluating the second <emu-nt><a href="https://tc39.github.io/ecma262/#prod-AssignmentExpression">AssignmentExpression</a></emu-nt>.</ins></li><li><ins>Let <var>attr</var> be ?&nbsp;<emu-xref aoid="GetValue" id="_ref_10"><a href="https://tc39.github.io/ecma262/#sec-getvalue">GetValue</a></emu-xref>(<var>attrRef</var>).</ins></li><li><ins>If <emu-xref aoid="Type" id="_ref_11"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>attr</var>) is not String,</ins><ol><li><ins><emu-xref aoid="Call" id="_ref_12"><a href="https://tc39.github.io/ecma262/#sec-call">Call</a></emu-xref>(_promiseCapability.[[Reject]], <emu-val>undefined</emu-val>, a new TypeError exception).</ins></li></ol></li><li><ins>Otherwise,</ins><ol><li>Perform !&nbsp;HostImportModuleDynamically(<var>referencingScriptOrModule</var>, <var>specifierString</var>, <ins><var>attr</var></ins> <var>promiseCapability</var>).</li></ol></li><li>Return <var>promiseCapability</var>.[[Promise]].
        </li></ol></emu-alg>
        <emu-note type="editor"><span class="note">Editor's Note</span><div class="note-contents">An exception is thrown for non-String values rather than calling <emu-xref aoid="ToString" id="_ref_13"><a href="https://tc39.github.io/ecma262/#sec-tostring">ToString</a></emu-xref> to allow later expansion to other values.</div></emu-note>
      </emu-clause>
    </emu-clause>

  <h1>TODO</h1>
  <ul>
    <li>RequestedModules becomes a <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref> of Records of the form { [[Specifier]]: String, [[Attribute]]: String }.</li>
    <li>Update the RequestedModules algorithm to calculate it correctly.</li>
    <li>Update InnerModuleLinking and InnerModuleEvaluation to pass both the specifier and attribute from [[RequestedModules]] records up to <emu-xref aoid="HostResolveImportedModule" id="_ref_14"><a href="https://tc39.github.io/ecma262/#sec-hostresolveimportedmodule">HostResolveImportedModule</a></emu-xref>.</li>
    <li>Update most other callsites of <emu-xref aoid="HostResolveImportedModule" id="_ref_15"><a href="https://tc39.github.io/ecma262/#sec-hostresolveimportedmodule">HostResolveImportedModule</a></emu-xref>, where the attribute is not so readily available, to search through [[RequestedModules]] to find the attribute value (or, to pass up a don't-care-sentinel).</li>
    <li>Add an <emu-xref href="#early-error"><a href="https://tc39.github.io/ecma262/#early-error">early error</a></emu-xref> for non-identical attributes for a single module specifier within a module. (This might be relaxed in a follow-on proposal. We could leave it up to the host environment to ensure consistency across the whole module graph, or we could add a link-time error for this as well, but in HTML, the host would notice before we would have the chance to.)</li>
    <li>Update <emu-xref aoid="HostResolveImportedModule" id="_ref_16"><a href="https://tc39.github.io/ecma262/#sec-hostresolveimportedmodule">HostResolveImportedModule</a></emu-xref> and HostImportModuleDynamically descriptions to explain the attribute and what invariants it has.</li>
  </ul>
</emu-clause>

<emu-annex id="sec-host-integration">
  <h1><span class="secnum">A</span> Sample host integration: The Web embedding</h1>

  <p>The module attributes proposal is intended to give key information about how modules are interpreted to hosts. For the Web embedding and environments which aim to be similar to it, the string is interpreted as the "module type". This is not the primary way the module type is determined (which, on the Web, would be the MIME type, and in other environments may be the file extension), but rather a secondary check which is required to pass for the module graph to load.</p>

  <p>In the Web embedding, the following changes would be made to the HTML specification for module attributes:</p>

  <ul>
    <li>The  <a href="https://html.spec.whatwg.org/#module-script">module script</a> would have an additional item, which would be the module type, as a string (e.g., "json" or "javascript").</li>
    <li><emu-xref aoid="HostResolveImportedModule" id="_ref_17"><a href="https://tc39.github.io/ecma262/#sec-hostresolveimportedmodule">HostResolveImportedModule</a></emu-xref> and HostImportModuleDynamically would take an extra "attribute" parameter, which would be passed down through several abstract operations to reach the  <a href="https://html.spec.whatwg.org/#fetch-a-single-module-script">fetch a single module script</a> algorithm. Somewhere near the entrypoint, <emu-val>undefined</emu-val> is replaced by "javascript" (or, alternatively, "executing", if JavaScript and WebAssembly are given a common name).</li>
    <li>In the  <a href="https://html.spec.whatwg.org/#fetch-the-descendants-of-a-module-script">fetch the descendents of a module script</a> algorithm, when iterating over [[RequestedModules]], the attribute is saved in parallel with module URLs, and passed on to the internal module script graph fetching procedure (which sends it to "fetch a single module script". Other usage sites of [[RequestedModules]] ignore the attribute.</li>
    <li>"Fetch a single module script" would check the attribute in two places:
      
      <ul>
        <li>If the module is found in the module map, then the attribute is checked against he module script's type field.</li>
        <li>When a new module is fetched, before writing it into the module map, the MIME type is checked against attribute value. The attribute value is written into the module script as the type.</li>
      </ul>
    </li>
  </ul>
</emu-annex>
</div></body>